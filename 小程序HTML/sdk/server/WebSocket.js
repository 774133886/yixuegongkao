var $=require("../jquery"),STATUS_NONE=0,STATUS_OPEN=1,STATUS_ERROR=2,STATUS_CLOSE=3,STATUS_TIMEOUT=4,STATUS_CONNECTING=5,noop=function(){};function WebSocket(t){$.extend(this,t),this.status=STATUS_NONE,0<t.retryCount&&(this.retryIndex=0)}var proto=WebSocket.prototype;proto.isOpen=function(){return this.status===STATUS_OPEN},proto.isConnecting=function(){return this.status===STATUS_CONNECTING},proto.connect=function(t,o){var r=this;if(r.status!==STATUS_OPEN&&r.status!==STATUS_CONNECTING){var e=[t];o&&o.length&&(e=e.concat(o));function n(){r.status===STATUS_CONNECTING&&function(o,n){function t(t){e&&clearTimeout(e),s.onOpen(noop),s.onError(noop),n(s,o,t)}var e,s=wx.connectSocket({url:o.url});s.onOpen(function(){t(STATUS_OPEN)}),s.onError(function(){console.log("socket error",arguments),t(STATUS_ERROR)}),0<r.timeout&&(e=setTimeout(function(){e=null,t(STATUS_TIMEOUT)},r.timeout))}(e[++s],function(t,o,n){if(r.status===STATUS_CONNECTING)if(n===STATUS_OPEN)r.url=o.url,r.socket=t,r.status=STATUS_OPEN,t.onMessage(function(t){r.status===STATUS_OPEN&&r.onReceive(JSON.parse(t.data))}),t.onClose(function(){console.log("socket closed",r.url,arguments),r.onClose&&r.onClose(),r.socket=null,r.status=STATUS_CLOSE}),0<r.retryCount&&(r.retryIndex=0),r.onOpen&&r.onOpen({server:o});else if(s===e.length-1){if(0<r.retryCount&&r.retryIndex++<r.retryCount)return s=-1,void T();switch(r.status=n){case STATUS_ERROR:r.onError&&r.onError();break;case STATUS_TIMEOUT:r.onTimeout&&r.onTimeout()}}else T()})}var s=-1,T=function(){0<r.interval?setTimeout(n,r.interval):n()};r.status=STATUS_CONNECTING,n()}},proto.send=function(t){var o=this.socket;o&&(o.send({data:"string"==typeof t?t:JSON.stringify(t)}),this.onSend&&this.onSend(t))},proto.close=function(){var t=this,o=$.Deferred(),n=this.socket;return this.socket=null,this.status=STATUS_CLOSE,n?(n.onMessage(noop),n.onClose(noop),n.close(),n.onClose(function(){t.onClose&&t.onClose(),o.resolve()})):o.resolve(),o},module.exports=WebSocket;