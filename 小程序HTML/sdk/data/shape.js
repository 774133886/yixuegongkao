var loadMap,store=require("../store"),eventEmitter=require("../eventEmitter"),docData=require("./doc"),$=require("../jquery"),util=require("../util");function getLoadKey(e){return e.docId+"-"+e.page}function getShapeList(e){return loadMap[getLoadKey(e)]}exports.init=function(){loadMap={},eventEmitter.on(eventEmitter.RECORD_SHAPE_CLEAN,function(){loadMap={}})},exports.add=function(e,t,r){var a=exports.get(e,t);if($.isArray(a)){$.isArray(r)||(r=[r]);var o=util.toObject(a,"id");$.each(r,function(e,t){o[t.id]||a.push(t)})}},exports.remove=function(e,t,r){var a=exports.get(e,t);if($.isArray(a)){var o=-1;$.each(a,function(e,t){if(t.id===r)return o=e,!1}),0<=o&&a.splice(o,1)}},exports.update=function(e,t,r){var a=getShapeList({docId:e,page:t});if($.isArray(a)){$.isArray(r)||(r=[r]);var o=util.toObject(a,"id");$.each(r,function(e,t){var r=o[t.id];r&&$.extend(r,t)})}},exports.get=function(e,t){return getShapeList({docId:e,page:t})},exports.clear=function(e,t){if(null!=e&&null!=t){var r=exports.get(e,t),a=getLoadKey({docId:e,page:t});$.isArray(r)&&(r.length=0,loadMap[a]=[])}else loadMap={}},exports.load=function(e,t){function a(e){n.resolve(e)}var o={docId:e,page:t},i=getLoadKey(o),r=loadMap[i]||{},n=$.Deferred();return r.done?r:($.isArray(r)?a(r):(loadMap[i]=n,eventEmitter.one(eventEmitter.SHAPE_ALL_RES,function(e,t){if(t.docId===o.docId&&t.page===o.page){var r=t.shapeList;loadMap[i]=r,exports.add(o.docId,o.page,r),a(r)}}).trigger(eventEmitter.SHAPE_ALL_REQ,o)),n)};