var reportTimer,config=require("./config"),language=require("./language"),$=require("../../api/jquery"),device=require("../../api/device"),camelCaseObject=require("./function/camelCaseObject"),simpleStrDecode=require("./function/simpleStrDecode"),getUuid=require("./function/getUuid"),doReport=require("./function/statisticReport"),info=require("./info"),render=(config=require("./config"),require("./function/render")),BJYMain=require("../../BJYMain"),eventEmitter=BJYMain.eventEmitter,STATUS_PLAY="playing",STATUS_PAUSE="pause",lastIsConnected=!0,netIsConnected=!0,needReplayWhenConnected=!1,POSITION_LEFT_TOP=1,POSITION_RIGHT_TOP=2,POSITION_RIGHT_BOTTOM=3,POSITION_LEFT_BOTTOM=4,AUDIO_ONLY="audio",networkType="";function fomateTime(e){return e=Math.floor(e),Math.floor(e/60)+"分"+e%60+"秒"}function getStorageKey(e){return"bjy-video-time-"+e}Component({properties:{vid:{type:Number,value:0,observer:function(e,t){var a=this;if(e){var n=wx.getStorageSync(getStorageKey(e));wx.createVideoContext("player",a);a.setData({showVideo:!1,vidChanged:!0,firstTimePlay:!0,currentDefinition:"",currentRate:1,currentTime:n||0,definitionOptions:[{key:"",name:""},{key:"",name:""},{key:"",name:""},{key:"",name:""},{key:"",name:""},{key:"",name:""}]}),a.setData({showVideo:!0}),a.data.autoplay||a.setData({showCustomPlayerImg:!0})}a.clearReportTimer(),a.getPlayInfo()}},env:{type:String,value:""},token:{type:String,value:""},rememberPlay:{type:Boolean,value:!1},customHourseLamp:{type:String,value:""},customReportString:{type:String,value:""},userNumber:{type:String,value:""},userName:{type:String,value:""},showRateSelection:{type:Boolean,value:!0},showDefinitionSelection:{type:Boolean,value:!0},currentDefinition:{type:String,value:"",observer:function(e,t){var a=this;e&&t&&(a.resetPlay(),a.data.status==STATUS_PLAY&&setTimeout(function(){wx.createVideoContext("player",a).play()},300),netIsConnected||(a.setData({replayTime:a.data.currentTime}),needReplayWhenConnected=!0))}},currentRate:{type:Number,value:1,observer:function(e,t){e&&this.setRate()}},initialTime:{type:Number,value:0},duration:{type:Number,value:0},controls:{type:Boolean,value:!0},danmuList:{type:Array,value:[]},danmuBtn:{type:Boolean,value:!1},enableDanmu:{type:Boolean,value:!1},autoplay:{type:Boolean,value:!1},loop:{type:Boolean,value:!1},muted:{type:Boolean,value:!1},pageGesture:{type:Boolean,value:!1},direction:{type:Number,value:90},showProgress:{type:Boolean,value:!0},showFullscreenBtn:{type:Boolean,value:!0},showPlayBtn:{type:Boolean,value:!0},showCenterPlayBtn:{type:Boolean,value:!0},enableProgressGesture:{type:Boolean,value:!0},objectFit:{type:String,value:"contain"},poster:{type:String,value:""},customPlayerImg:{type:Object,value:{url:"",css:""}},customPlayerBtn:{type:Object,value:{content:"",css:""}}},data:{url:"",hideStatus:STATUS_PLAY,showCustomPlayerImg:!0,watermark:{url:"http://live-cdn.baijiayun.com/video-cloud/asset/frontend/common/img/logo_dc21e98998.png",pos:""},reportUrl:"",showOptions:!1,videoInfo:{},currentCdn:"",currentTime:0,lastEndTime:-1,isSeeking:!1,seekFrom:0,seekTo:0,isNetworkStatusChanged:!1,loadStartTime:0,blockStartTime:0,waitTime:0,firstTimePlay:!0,audioCoverHeight:0,rateOptions:[{key:.5,name:"0.5x"},{key:.8,name:"0.8x"},{key:1,name:"1.0x"},{key:1.25,name:"1.25x"},{key:1.5,name:"1.5x"}],definitionOptions:[{key:"",name:""},{key:"",name:""},{key:"",name:""},{key:"",name:""},{key:"",name:""},{key:"",name:""}],reportInterval:6e4,showVideo:!0},ready:function(){var e=this;e.initNetStatus(),e.setAudioCoverHeight(!1),eventEmitter.on(eventEmitter.PAGE_HIDE,function(){device.isAndroid()||device.isAndroid()||e.setData({hideStatus:e.data.status})}),eventEmitter.on(eventEmitter.PAGE_SHOW,function(){device.isAndroid()||(e.setData({replayTime:e.data.currentTime}),e.replay())})},methods:{getPlayInfo:function(){var n=this,e=n.data;if(e.vid){var t={vid:e.vid,client_type:"miniprogram"};device.isDevtools()&&(t.client_type="miniprogram-dev"),e.token&&(t.token=e.token),e.verifyCode&&(t.verify_code=e.verifyCode),n.clearReportTimer(),wx.request({url:config["REQUEST_PATH"+e.env],data:t,success:function(e){var t=e.data;if(console.log("--------response data-------------"),console.log(e),0==t.code){var a=camelCaseObject(e.data.data);n.setData({videoInfo:a,duration:a.duration,reportInterval:1e3*a.reportInterval}),n.setDefinitions(),n.beginPlay()}else t.msg&&info.tip(t.msg)},fail:function(e){console.log("request error: "+JSON.stringify(e))}})}},initNetStatus:function(){var t=this;wx.onNetworkStatusChange(function(e){t.onNetworkStatusChange(e)})},onNetworkStatusChange:function(e){var t=this;if(t.data.isNetworkStatusChanged)return!1;t.setData({isNetworkStatusChanged:!0}),setTimeout(function(){t.setData({isNetworkStatusChanged:!1})},5e3);var a=netIsConnected=e.isConnected;networkType=e.networkType,a?("wifi"!=networkType&&info.alert(language.NO_WIFI),lastIsConnected||needReplayWhenConnected&&t.replay()):info.alert(language.NO_NETWORK),lastIsConnected=e.isConnected},replay:function(){var e=this,t=e.data,a=t.url,n=wx.createVideoContext("player",e);e.setData({url:""}),e.setData({url:a+"?v="+(new Date).getTime()}),setTimeout(function(){n.seek(e.data.replayTime),n.play(),n.playbackRate(t.currentRate)},1e3)},setAudioCoverHeight:function(e){var a=this;if(e){var t=wx.getSystemInfoSync().screenHeight;a.data.controls&&(t-=48),a.setData({audioCoverHeight:t})}else{var n=wx.createSelectorQuery().in(a);n.select("#bjy-video-wrapper").boundingClientRect(),n.exec(function(e){var t=e[0].height;a.data.controls&&(t-=48),a.setData({audioCoverHeight:t})})}},setDefinitions:function(){for(var e,t=this,a=t.data.videoInfo,n=a.definition,i=[],r=0;e=n[r++];)i.push({key:e.type,name:e.name});a.audioUrl&&i.push({key:AUDIO_ONLY,name:language.AUDIO_ONLY});var o={definitionOptions:i},s=t.data.currentDefinition;""===t.data.currentDefinition&&(o.currentDefinition=a.vodDefaultDefinition,s=a.vodDefaultDefinition),o.currentCdn=a.playInfo[s].cdnList[0].cdn,t.setData(o)},beginPlay:function(){var e=this,t=e.data.videoInfo,a=e.data,n=(a.currentDefinition,a.currentCdn,e.getVideoPlayInfo());t.videoWatermark.position=+t.videoWatermark.position,e.setData({watermark:t.videoWatermark}),a.poster||e.setData({poster:t.initPic}),e.setWatermarkPosition(),e.playVideo(n)},resetPlay:function(){var e=this.getVideoPlayInfo();this.playVideo(e)},changeDefinition:function(){this.data.videoInfo;var e=this.data;e.currentDefinition,e.currentCdn},changeCdn:function(){var e=this.getNextCdn();return!!e&&(this.setData({currentCdn:e.cdn}),this.resetPlay(),!0)},getNextCdn:function(){for(var e,t=this.data,a=t.currentDefinition,n=this.data.videoInfo,i=t.currentCdn,r=n.playInfo[a].cdnList,o=0;e=r[o++];)if(e.cdn==i)return r[o];return null},playVideo:function(e){var t=this,a=getUuid(),n="",i=(t.data.videoInfo,t.data),r=i.currentTime,o=e.encUrl&&simpleStrDecode(e.encUrl)||e.url;t.setData({playInfo:e}),i.url!=o&&(n=-1<o.indexOf("?")?o+"&uuid="+a:0<o.length?o+"?uuid="+a:o,t.setData({url:n}),setTimeout(function(){t.initPlayer(r),t.setData({vidChanged:!1})},300))},initPlayer:function(e){var t=this.data,a=wx.createVideoContext("player",this);a.playbackRate(t.currentRate);wx.getStorageSync(getStorageKey(t.vid));t.autoplay?a.play():this.data.firstTimePlay||t.status!=STATUS_PLAY||a.play(),this.data.firstTimePlay||a.seek(e)},setWatermarkPosition:function(){var e="";switch(+this.data.videoInfo.videoWatermark.pos){case POSITION_LEFT_TOP:e="watermark-left-top";break;case POSITION_LEFT_BOTTOM:e="watermark-left-bottom";break;case POSITION_RIGHT_TOP:e="watermark-right-top";break;case POSITION_RIGHT_BOTTOM:e="watermark-right-bottom"}this.setData({watermarkClass:e})},getVideoPlayInfo:function(){var e=this.data,n=e.currentDefinition,i=e.currentCdn,r=this.data.videoInfo;return n==AUDIO_ONLY?{encUrl:r.audioUrl}:function(){for(var e,t=r.playInfo[n].cdnList,a=0;e=t[a++];)if(e.cdn==i)return e}()},statisticReport:function(e){var t=this,a=t.data,n=a.videoInfo,i=t.data.playInfo,r=a.currentTime,o=a.lastEndTime,s=a.reportInterval,u=n,l=(t.data,Math.round(1e3*o)),d=Math.round(1e3*r);"play"==(e={type:"video_vod",guid:u.guid,clientype:device.clientType(),userName:a.userName,userNumber:a.userNumber,env:t.data.env,fid:u.videoId,playbegintime:l,playendtime:d,cdn:i&&i.cdn,event:e.event,resolution:t.data.currentDefinition,networkType:networkType,playfiletype:u.format,partner_id:u.videoInfo.partnerId,totaltime:Math.round(1e3*u.duration),extern:"",filesize:i.size,customstr:t.customStr||""}).event&&(e.playbegintime=e.playendtime),e.playendtime<e.playbegintime&&(e.playendtime=e.playbegintime),"firstplaywait"!=e.event&&"blockend"!=e.event||(e.waittime=a.waitTime),"seek"==e.event&&(e.playendtime=Math.round(1e3*a.seekFrom),e.seekTo=Math.round(1e3*a.seekTo),r=a.seekTo);var c=e.playbegintime+1e3*s;e.playendtime>c&&(e.playendtime=c),e.bufbegintime=e.playbegintime,e.bufendtime=e.playendtime,e.duration=e.playendtime-e.playbegintime,doReport(t,e),t.setData({lastEndTime:r})},beginReportTimer:function(){var e=this,t=(e.data.videoInfo,e.data.reportInterval);t&&(reportTimer||(reportTimer=setInterval(function(){e.statisticReport({event:"normal"})},t)))},clearReportTimer:function(){reportTimer&&clearInterval(reportTimer),reportTimer=null},setRate:function(){wx.createVideoContext("player",this).playbackRate(this.data.currentRate)},audioCoverTap:function(){this.setData({controls:!0})},onPlay:function(e){var t=this,a=t.data;t.setData({status:STATUS_PLAY,showCustomPlayerImg:!1}),setTimeout(function(){t.statisticReport({event:"play"})},1e3),t.beginReportTimer();var n=wx.getStorageSync(getStorageKey(a.vid)),i=wx.createVideoContext("player",t);a.firstTimePlay&&(console.log("首次起播"),t.setData({loadStartTime:(new Date).getTime()})),a.rememberPlay&&a.firstTimePlay&&1<n&&(t.setData({firstTimePlay:!1}),a.autoplay?(i.play(),i.seek(n)):(i.pause(),info.confirm({content:render(language.CONTINUE_PLAY,{time:fomateTime(n)})}).then(function(){i.play(),i.seek(n)},function(){i.play()}))),t.setData({firstTimePlay:!1})},customPlay:function(){wx.createVideoContext("player",this).play()},customPause:function(){wx.createVideoContext("player",this).pause()},customStop:function(){wx.createVideoContext("player",this).stop()},customSeek:function(e){wx.createVideoContext("player",this).seek(e)},onRateTap:function(e){var t=e.detail,a=this.data.currentRate;t.key!=a&&this.setData({currentRate:+t.key})},onDefinitionTap:function(e){var t=e.detail,a=this.data.currentDefinition;t.key!=a&&(this.setData({currentDefinition:t.key}),t.key==AUDIO_ONLY&&this.setAudioCoverHeight(this.data.fullScreen))},onImageError:function(e){},onPause:function(e){var t=this;console.log("onpause"),console.log(e),t.data.firstTimePlay||t.statisticReport({event:"pause"}),t.setData({status:STATUS_PAUSE,showCustomPlayerImg:!0}),t.clearReportTimer(),t.triggerEvent("pause",e)},onVideoTap:function(e){console.log("onVideoTap")},onEnded:function(e){var t=this,a=t.data,n=wx.getStorageSync(getStorageKey(a.vid));if(!n||1<Math.abs(n-a.duration))return!1;console.log("ended"),t.statisticReport({event:"endplay"}),t.setData({currentTime:0,lastEndTime:0,showCustomPlayerImg:!0}),t.clearReportTimer(),t.triggerEvent("ended",e),wx.removeStorageSync(getStorageKey(a.vid))},detached:function(){},onTimeupdate:function(e){var t=this,a=t.data,n=e.detail.currentTime;if(!a.vidChanged){if(a.loadStartTime){var i=(new Date).getTime()-a.loadStartTime;t.setData({waitTime:i}),t.statisticReport({event:"firstplaywait"}),t.setData({loadStartTime:0,waitTime:0})}if(a.blockStartTime){i=(new Date).getTime()-a.blockStartTime;t.setData({waitTime:i}),t.statisticReport({event:"blockend"}),t.setData({blockStartTime:0,waitTime:0})}3<=Math.abs(n-t.data.currentTime)&&(t.setData({isSeeking:!0,seekFrom:t.data.currentTime,seekTo:n}),t.statisticReport({event:"seek"}),t.setData({isSeeking:!1,seekFrom:0,seekTo:0})),t.setData({currentTime:n}),-1==a.lastEndTime&&t.setData({lastEndTime:n}),a.rememberPlay&&1<n&&wx.setStorage({key:getStorageKey(a.vid),data:n}),t.triggerEvent("timeupdate",e)}},onFullscreenchange:function(e){var t=e.detail.fullScreen;this.setData({fullScreen:t}),this.data.currentDefinition==AUDIO_ONLY&&this.setAudioCoverHeight(t),this.triggerEvent("fullscreenchange",e)},onWaiting:function(e){var t=this;t.data.firstTimePlay||t.data.loadStartTime||t.data.status!==STATUS_PLAY||(t.clearReportTimer(),t.statisticReport({event:"block"}),t.setData({blockStartTime:(new Date).getTime()}),t.triggerEvent("waiting",e))},onError:function(e){var t=this;t.statisticReport({event:"playerror"}),t.clearReportTimer(),t.changeCdn()||t.setData({showCustomPlayerImg:!0}),t.triggerEvent("error",e)}}});